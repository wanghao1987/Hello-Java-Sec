<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<div th:replace="~{commons/commons::head}"></div>

<body>
<!-- 顶部导航栏 -->
<div th:replace="~{commons/commons::topbar}"></div>

<div class="container-fluid">
    <div class="row">
        <!-- 侧边栏 -->
        <div th:replace="~{commons/commons::siderbar(active='xss_store.html')}"></div>

        <main role="main" class="col-md-9 ml-sm-auto col-lg-10 pt-3 px-4">
            <div class="vul_header">
                <span>Stored XSS Attack</span>
            </div>
            <h3></h3>
            <hr>
            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a class="nav-link active" data-toggle="tab" href="#aa"><span class="lnr lnr-bug"></span>
                        Vulnerability description</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#bb"><span class="lnr lnr-bullhorn"></span> Secure Coding</a>
                </li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane dec shadow-sm p-3 mb-4 rounded active" id="aa">
                    Stored attacks are those where the injected script is permanently stored on the target servers, such as in a database, in a message forum, visitor log, comment field, etc. The victim then retrieves the malicious script from the server when it requests the stored information. Stored XSS is also sometimes referred to as Persistent or Type-II XSS.
                </div>
                <div class="tab-pane fade" id="bb">
                    <textarea disabled="disabled" class="form-control shadow-sm p-3 mb-5 rounded" id="coder"
                              style="height: 260px;">
【Mandatory】Encode external input before concatenating it into the response page.
When the response "content-type" is of "html" type, external input concatenated into the response packet must be encoded according to the output position. Encode the following 6 special characters into HTML entities (&, <, >, ", ', /), or refer to and directly use mature third-party libraries such as ESAPI.

【Mandatory】Set the correct HTTP response packet type.
The HTTP header "Content-Type" of the response packet must be correctly configured with the type of the response packet, and it is forbidden to set non-HTML types of response packets to "text/html". This action will cause the browser to interpret non-HTML format response messages as HTML when accessing the link directly, increasing the chance of triggering reflective XSS.

【Recommendation】Set secure HTTP response headers.
Control the Cookie field for user login authentication, and set the HttpOnly attribute to prevent XSS vulnerabilities/JavaScript manipulation leaks.
                    </textarea>
                </div>
            </div>
            <hr>

            <div class="box-float">
                <div class="float1">
                    <h5><span class="lnr lnr-bug"> Test</span></h5>
                    <div class="container">
                        <div class="card">
                            <div class="card-body">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="content" name="content"
                                           value="<script>alert(1)</script>" style="color: #b5babb">
                                    <div class="input-group-append">
                                        <button type="submit" class="btn btn-sm btn-danger" onclick="submitForm()">Submit
                                        </button>
                                    </div>
                                </div>
                                <hr>
                                <div class="form-group">
                                    <table class="table table-striped table-bordered table-sm" id="xssTableVul">
                                        <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Data</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>                  
                </div>              
            </div>
        </main>
    </div>
</div>

<!-- 引入script -->
<div th:replace="~{commons/commons::script}"></div>
<script>
    function submitForm() {
        const content = document.getElementById("content").value || document.getElementById("content2").value;
        const xhr = new XMLHttpRequest();

        xhr.open("POST", "/XSS/save");
        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        xhr.send("content=" + encodeURIComponent(content));

        // 处理响应
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4 && xhr.status == 200) {
                //alert("提交成功")
                location.reload();
            }
        };
    }

    $(document).ready(function () {
        $.ajax({
            url: '/XSS/getStored',
            method: 'GET',
            success: function (data) {
                $.each(data, function (index, item) {
                    $('#xssTableVul tbody').append('<tr><td>' + item.id + '</td><td>' + item.content + '</td><td><button class="btn btn-sm" onclick="deleteRow(' + item.id + ')"><span class="lnr lnr-trash"></span></button></td></tr>');
                    $('#xssTableSafe tbody').append('<tr><td>' + item.id + '</td><td>' + $('<div/>').text(item.content).html() + '</td><td><button class="btn btn-sm" onclick="deleteRow(' + item.id + ')"><span class="lnr lnr-trash"></span></button></td></tr>');
                });
            }
        });
    });

    function deleteRow(id) {
        $.ajax({
            url: '/XSS/delete?id=' + id,
            method: 'GET',
            success: function () {
                location.reload();
            }
        });
    }
</script>
</body>
</html>